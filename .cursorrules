# Belmobile Project Rules (Critical)
> [!IMPORTANT]
> **AI CONTEXT**: Always reference `.agent/system-memory.md` for high-level architecture diagrams, tech stack versions, and core refactor history. This prevents context drift.

You are working on the **Belmobile Next.js 16 (Canary)** project.
Your goal is **Premium Quality** and **Zero Regression**.

## üß† Mental Model (Proactive Senior Dev)
> - **Mission**: Anticipate project needs, identify edge cases, and propose optimizations autonomously.
> - **Technical Audit**: Proactively verify the impact of every change on "Consumers", observability (Sentry), and Core Web Vitals (SEO/Image).
> - **Scalability**: Suggest architectures that facilitate the addition of future features.
> - **Autonomy**: Update documentation (`system-memory.md`) and tracking (`task.md`) systematically after major changes.

## üõë Architecture & Deployment (Strict)
1.  **Frontend Host**: Vercel ONLY.
    - **Do NOT** run `firebase deploy` (without flags). This overwrites hosting.
    - **ALLOWED**: `firebase deploy --only firestore:rules` (for security rule updates).
    - **Do NOT** enable Vercel Authentication on Staging (breaks app-level PIN).
2.  **Backend**: Firebase (Auth, Firestore, Storage) via SDK.
    - All file uploads MUST go to `ref(storage, ...)` in Firebase SDK.
    - Never store files locally or in `./public/uploads` (Vercel is ephemeral).
3.  **Deployment Workflow**:
    - **Staging**: Push to `staging` branch first. Verify on Vercel Preview.
    - **Production**: Merge to `main`. Deploys to Vercel Production.
4.  **Proxy Convention (Next.js 16+)**: ALWAYS use `src/proxy.ts`. usage of `middleware.ts` is explicitly DEPRECATED.
    - **Reason**: Next.js 16+ "Proxy Convention" replaces Middleware to decouple routing from heavy logic.
    - **Rule**: Export `proxy` function in `src/proxy.ts`, NOT `middleware`.
    - **Sentry**: Ensure `matcher` in `proxy.ts` excludes `/monitoring`.
5.  **Linting**: Ignore local `npm run lint` crashes (Windows/ESLint 9 incompatibility).
    - **Trust only `npm run build`**. If build passes, code is valid.

## üèéÔ∏è Performance Doctrine (Core Vitals)
1.  **Images (`next/image`)**:
    - **Mandatory**: ALL images must use `next/image`.
    - **LCP Rule**: The largest image above the fold MUST have `priority` or `loading="eager"`.
    - **Sizes Prop**: You MUST provide a `sizes` prop for responsive sizing (e.g., `(max-width: 768px) 100vw, 50vw`) to avoid serving desktop images to mobile.
    - **Format**: Rely on automatic WebP/AVIF optimization; do not hardcode `.png` paths if a localized component handles it.
2.  **Dynamic Imports**:
    - **Heavy Libs**: Libraries like `jspdf`, `framer-motion`, or `leaflet` MUST be dynamically imported inside `useEffect` or via `next/dynamic` if they are not critical for the initial paint.
    - **Components**: "Below the fold" components (like `ReviewsSection`) should be lazy-loaded.
3.  **Font Optimization**: Use `next/font/google`. NEVER use `<link>` tags for Google Fonts.

## üîé SEO Strictness & Metadata
1.  **Heading Hierarchy**:
    - **H1**: EXACTLY ONE per page.
    - **Nesting**: H2 must follow H1, H3 must follow H2. No skipping levels for style. Use CSS/Tailwind for sizing, not tags.
2.  **Redirects**:
    - **Source of Truth**: ALL legacy redirects belong in `src/utils/legacyUrlMap.ts`. Do not clutter `next.config.ts`.
3.  **Schema Markup**:
    - Manage JSON-LD via `src/components/DynamicSEOContent.tsx`. Do not scatter `<script>` tags in pages.
4.  **Metadata**:
    - Use the Next.js `generateMetadata` API. Never use manual `<head>` tags for title/description.

## üìÇ Architecture & Patterns
1.  **Layouts**: Use "Client Wrappers" (e.g., `LayoutWrapper.tsx`) to hide headers/footers. Do NOT refactor into complex Route Groups (`(shop)`, `(main)`) as this breaks `legacyUrlMap` linking.
2.  **Translations**:
    - Prefer **lazy-loading** per-language JSONs.
    - **Do NOT** add massive objects to `translations.ts` (deprecated pattern).
3.  **Glassmorphism**: Follow `.agent/design-system.md`. Use `backdrop-blur-md` and `bg-white/70`, not solid opacities.
4.  **Wizard Pattern (Buyback/Repair)**:
    - **State Management**: Use `WizardContext` and `useWizard` hook. Never prop-drill wizard state.
    - **Actions**: Use `useWizardActions` for navigation and selection logic.
    - **Pricing**: Use `useWizardPricing` for all estimate calculations.
    - **Components**: Keep step components modular in `src/components/wizard/steps/`. Use `StepWrapper` for animations and `StepIndicator` for progress.
    - **Services**: Complex logic (PDF generation, order submission) MUST go in `src/services/orderService.ts`.
    - **Responsive Padding**: Wizard outer containers should use `p-3 sm:p-6 lg:p-8` to maximize mobile space.

## ‚ö†Ô∏è Common Pitfalls (Auto-Reject)
- Renaming `proxy.ts` -> `middleware.ts`.
- "Fixing" lines that rely on `any` casting *unless* you verify the type definition exists (Project has some tight casting for legacy data).
- Removing `console.error` in `catch` blocks (We need observability).

## üìà Growth & Operations (Phase Z)
1.  **Lead Recovery**:
    - **Magic Links**: State restoration MUST be handled centrally in `BuybackRepair.tsx`.
    - **GDPR**: Every lead record MUST have an `expiresAt` ISO string.
2.  **Automated Reviews**:
    - **Trigger**: Only trigger `api/mail/schedule-review` on `status === 'completed'`.
3.  **Reporting**:
    - **Data Integrity**: Financial reporting MUST use the `price` field from the Firestore doc, not recalculated client-side values.

- **Verification Logic**: 
  - **Lint-Fix**: Immediately correct lint errors (`any`, typos, implicit types) in files being edited.
  - **Environment**: If `next.config.ts` or `package.json` changes, run `npm run dev` to verify environment stability.
  - **Compliance**: Proactively check H1-H6 hierarchy and `priority` attributes for images.
  - **Patterns**: Enforce `useWizard` context usage instead of prop-drilling in the Wizard flow.
- **Golden Rule**: Run `npm run build` after *any* significant change.
- **Visual**: If modifying UI, enable "Mobile View" in devtools to verify responsive `sizes` and layout.
